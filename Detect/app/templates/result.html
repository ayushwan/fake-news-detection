{% extends "base.html" %}

{% block head_extra %}
<style>
    .result-card {
        border-radius: 15px;
        padding: 2rem;
        text-align: center;
        color: white;
        margin-top: 2rem;
    }
    .result-card.real {
        background: linear-gradient(135deg, #28a745, #218838);
    }
    .result-card.fake {
        background: linear-gradient(135deg, #dc3545, #c82333);
    }
    .result-card.error, .result-card.na {
        background: linear-gradient(135deg, #6c757d, #5a6268);
    }
    .result-card h2 {
        font-size: 3rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
    }
    .result-card .confidence {
        font-size: 1.5rem;
        margin-bottom: 1.5rem;
    }
    .result-card .news-input-display {
        background-color: rgba(255,255,255,0.1);
        padding: 1rem;
        border-radius: 8px;
        margin-bottom: 1.5rem;
        max-height: 150px;
        overflow-y: auto;
        text-align: left;
        font-family: monospace;
        font-size: 0.9rem;
        word-break: break-all;
    }
    .share-buttons .btn {
        margin: 0.5rem;
        min-width: 150px;
    }
    .action-buttons .btn {
        margin-top: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            {% set card_class = 'na' %}
            {% if prediction == 'REAL' %}
                {% set card_class = 'real' %}
            {% elif prediction == 'FAKE' %}
                {% set card_class = 'fake' %}
            {% elif prediction == 'ERROR' %}
                {% set card_class = 'error' %}
            {% endif %}

            <div class="result-card shadow-lg animate__animated animate__zoomIn {{ card_class }}" id="resultCard">
                {% if prediction == 'ERROR' %}
                    <h2><i class="fas fa-exclamation-triangle me-2"></i>Error</h2>
                    <p class="confidence">An error occurred during prediction.</p>
                    <p>We were unable to process your request. Please try again later or contact support if the issue persists.</p>
                {% elif prediction == 'N/A' %}
                    <h2><i class="fas fa-question-circle me-2"></i>Unavailable</h2>
                    <p class="confidence">Prediction is currently unavailable.</p>
                    <p>The machine learning model might not be loaded. Please check the system status or contact an administrator.</p>
                {% else %}
                    <h2>{{ prediction }}</h2>
                    <p class="confidence">Confidence: <strong>{{ confidence }}%</strong></p>
                    
                    <div class="news-input-display">
                        <strong>Submitted Input:</strong><br>
                        <small>{{ news_input|truncate(300, True) if news_input else 'N/A' }}</small>
                    </div>

                    <p>This prediction is based on our AI model. Always cross-verify information from multiple reliable sources.</p>
                    
                    <div class="share-buttons mb-3">
                        <h5>Share this result:</h5>
                        <button class="btn btn-light btn-sm share-btn" data-platform="whatsapp"><i class="fab fa-whatsapp me-1"></i> WhatsApp</button>
                        <button class="btn btn-light btn-sm share-btn" data-platform="twitter"><i class="fab fa-twitter me-1"></i> Twitter</button>
                        <button class="btn btn-light btn-sm share-btn" data-platform="facebook"><i class="fab fa-facebook me-1"></i> Facebook</button>
                        <button class="btn btn-light btn-sm share-btn" data-platform="telegram"><i class="fab fa-telegram me-1"></i> Telegram</button>
                        <button class="btn btn-light btn-sm share-btn" data-platform="linkedin"><i class="fab fa-linkedin me-1"></i> LinkedIn</button>
                    </div>

                    <div class="action-buttons">
                        <button id="copyResultBtn" class="btn btn-outline-light"><i class="fas fa-copy me-1"></i> Copy Result Text</button>
                        <button id="downloadPdfBtn" class="btn btn-outline-light"><i class="fas fa-file-pdf me-1"></i> Download as PDF</button>
                    </div>
                {% endif %}
            </div>

            <div class="text-center mt-4">
                <a href="{{ url_for('main.submit_news') }}" class="btn btn-secondary"><i class="fas fa-redo-alt me-1"></i> Analyze Another Article</a>
                <a href="{{ url_for('main.history') }}" class="btn btn-info"><i class="fas fa-history me-1"></i> View Submission History</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const prediction = "{{ prediction }}";
        const confidence = "{{ confidence }}";
        const newsInput = "{{ news_input|escapejs }}"; // Ensure news_input is properly escaped for JS
        const siteUrl = window.location.origin;
        const resultPageUrl = window.location.href;
        const articleId = "{{ article_id }}"; // If you want to link directly to a stored result

        const resultTextForSharing = `News Analysis Result:\nPrediction: ${prediction}\nConfidence: ${confidence}%\nInput: ${newsInput.substring(0,100)}...\nChecked on: ${siteUrl}`;
        const resultTextForCopy = `Prediction: ${prediction}\nConfidence: ${confidence}%\nInput Summary: ${newsInput.substring(0,200)}...`;

        // Share buttons
        document.querySelectorAll('.share-btn').forEach(button => {
            button.addEventListener('click', function () {
                const platform = this.dataset.platform;
                let url = '';
                const encodedText = encodeURIComponent(resultTextForSharing + `\nMore details: ${resultPageUrl}`);

                switch (platform) {
                    case 'whatsapp':
                        url = `https://api.whatsapp.com/send?text=${encodedText}`;
                        break;
                    case 'twitter':
                        url = `https://twitter.com/intent/tweet?text=${encodedText}`;
                        break;
                    case 'facebook':
                        url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(resultPageUrl)}&quote=${encodedText}`;
                        break;
                    case 'telegram':
                        url = `https://t.me/share/url?url=${encodeURIComponent(resultPageUrl)}&text=${encodedText}`;
                        break;
                    case 'linkedin':
                        url = `https://www.linkedin.com/shareArticle?mini=true&url=${encodeURIComponent(resultPageUrl)}&title=News%20Analysis%20Result&summary=${encodedText}`;
                        break;
                }
                if (url) {
                    window.open(url, '_blank');
                } else {
                    Swal.fire('Not implemented', 'This sharing option is not yet configured.', 'info');
                }
            });
        });

        // Copy result button
        const copyResultBtn = document.getElementById('copyResultBtn');
        if (copyResultBtn) {
            copyResultBtn.addEventListener('click', function () {
                navigator.clipboard.writeText(resultTextForCopy)
                    .then(() => {
                        Swal.fire({icon: 'success', title: 'Copied!', text: 'Result copied to clipboard.', timer: 1500, showConfirmButton: false});
                    })
                    .catch(err => {
                        console.error('Failed to copy: ', err);
                        Swal.fire({icon: 'error', title: 'Oops...', text: 'Failed to copy text.'});
                    });
            });
        }

        // Download PDF button
        const downloadPdfBtn = document.getElementById('downloadPdfBtn');
        if (downloadPdfBtn) {
            downloadPdfBtn.addEventListener('click', function () {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFontSize(18);
                doc.text("Fake News Detection Result", 105, 20, null, null, 'center');
                
                doc.setFontSize(12);
                doc.text(`Prediction: ${prediction}`, 20, 40);
                doc.text(`Confidence: ${confidence}%`, 20, 50);
                
                doc.text("Submitted Input:", 20, 60);
                // Use splitTextToSize for potentially long input text
                const splitInput = doc.splitTextToSize(newsInput, 170); // 170 is approx width for A4
                doc.text(splitInput, 20, 70);
                
                let finalY = 70 + (splitInput.length * 7); // Estimate Y position after text

                doc.setFontSize(10);
                doc.text(`Analyzed on: ${new Date().toLocaleString()}`, 20, finalY + 10);
                doc.text(`Source: ${siteUrl}`, 20, finalY + 15);

                doc.save(`news_analysis_result_${articleId || 'report'}.pdf`);
                Swal.fire({icon: 'success', title: 'Downloaded!', text: 'Result PDF downloaded.', timer: 1500, showConfirmButton: false});
            });
        }
    });
</script>
{% endblock %}